(function(){var t={}.hasOwnProperty,e=function(e,r){function s(){this.constructor=e}for(var i in r)t.call(r,i)&&(e[i]=r[i]);return s.prototype=r.prototype,e.prototype=new s,e.__super__=r.prototype,e},r=[].indexOf||function(t){for(var e=0,r=this.length;r>e;e++)if(e in this&&this[e]===t)return e;return-1};Batman.SubSet=function(t){function r(t,e){var s,i,n;n=null!=e?e:{},i=n.offset,s=n.limit,r.__super__.constructor.call(this,t),this.set("offset",i),this.set("limit",s),this._redefine()}return e(r,t),r.prototype.observe("limit",function(){return this._redefine()}),r.prototype.observe("offset",function(){return this._redefine()}),r.accessor("offset",{get:function(){return this._offset||0},set:function(t,e){return this._offset=Math.max(e,0)}}),r.accessor("start",function(){return this.get("offset")}),r.accessor("end",function(){return this.get("offset")+this.get("limit")}),r.prototype.tracksAnyOf=function(t){var e,r;return(null!=t?t.length:void 0)?(r=Math.min.apply(Math,t),e=Math.max.apply(Math,t),"Number"!==Batman.typeOf(r)||"Number"!==Batman.typeOf(e)?!0:r>this.get("end")||e<this.get("start")?!1:!0):!0},r.prototype._handleItemsAdded=function(t,e){return this.tracksAnyOf(e)?this._redefine():void 0},r.prototype._handleItemsRemoved=function(t,e){return this.tracksAnyOf(e)?this._redefine():void 0},r.prototype._handleItemsModified=function(){return console.warn("Batman.SubSet#_handleItemsModified is not implemented."),this._redefine()},r.prototype._redefine=function(){var t,e,r,s,i,n,o,a,u,c,h,f,l,g,p,d,m,_;for(n=this.base.toArray().slice(this.get("offset"),this.get("offset")+this.get("limit")),f={items:[],indexes:[]},t={items:[],indexes:[]},h=this.get("_storage")||[],o=n.slice(),a={},e=l=0,p=o.length;p>l;e=++l)r=o[e],a[""+e]=r;for(u=g=0,d=h.length;d>g;u=++g)c=h[u],i=n.filter(function(t){return t.valueOf()===c.valueOf()})[0],i?(s=n.indexOf(i),delete a[""+s]):(f.items.push(c),f.indexes.push(u));for(e in a)r=a[e],t.items.push(r),t.indexes.push(+e);return this.fire("itemsWereRemoved",f.items.reverse(),f.indexes.reverse()),null!=(m=this._setObserver)&&m.stopObservingItems(f.items),this.fire("itemsWereAdded",t.items,t.indexes),null!=(_=this._setObserver)&&_.startObservingItems(t.items),this.set("_storage",n),this.set("length",n.length),this.set("last",this.at(this.get("length")))},r.prototype.toArray=function(){var t;return"function"==typeof(t=this.base).registerAsMutableSource&&t.registerAsMutableSource(),this._storage.slice()},r.prototype.forEach=function(t,e){var r,s,i,n,o,a;for("function"==typeof(i=this.base).registerAsMutableSource&&i.registerAsMutableSource(),a=this._storage,s=n=0,o=a.length;o>n;s=++n)r=a[s],t.call(e,r,s,this)},r.prototype.at=function(t){return this._storage[t]},r.accessor("first",{get:function(){return this.at(0)},cache:!1}),r.prototype.has=function(t){var e,r,s,i;for(i=this.toArray(),r=0,s=i.length;s>r;r++)if(e=i[r],e===t)return!0;return!1},r}(Batman.SetProxy),Batman.Paginator=function(t){function s(t){var e,r;null==t&&(t={}),e={limit:10,offset:0,prefetch:!1,index:t.model.get("loaded.sortedBy.id")},r={queryParams:new Batman.Hash(t.queryParams||{})},s.__super__.constructor.call(this,Batman.extend(e,t,r)),this.set("_state",this._STATES.READY),this.set("total",0)}return e(s,t),s.SEARCH_TERM_PARAM="q",s.APPEND_JSON=!0,s.prototype.observe("requestURL",function(){return this._loadRecords()}),s.accessor("adapter",function(){return this.get("model").prototype._batman.get("storage")}),s.accessor("modelURL",function(){var t;return t=this.url||this.get("adapter").urlForCollection(this.get("model"),{}),this.constructor.APPEND_JSON&&-1===t.indexOf(".json")&&(t+=".json"),t}),s.accessor("requestURL",function(){var t,e;return t="offset="+this.get("offset")+"&limit="+this.get("limit"),this.get("queryParams").forEach(function(e,r){return t+="&"+e+"="+r}),this.get("searchTerm")&&(t+="&"+this.constructor.SEARCH_TERM_PARAM+"="+this.get("searchTerm")),e=""+this.get("modelURL")+"?"+t}),s.accessor("searchRegExp",function(){var t,e;return t=this.get("searchTerm").replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&"),e=t.replace(" ",".* "),new RegExp("(^| )"+e,"i")}),s.accessor("results",function(){return this.get("searchTerm")?this._filteredSubSet():(this._loadRecords(),this.resultSubSet||(this.resultSubSet=new Batman.SubSet(this.get("index"),{offset:this.get("offset"),limit:this.get("limit")})))}),s.prototype._filteredSubSet=function(){return this.filteredIndex=this.get("index").filter(function(t){return function(e){var r,s,i;return t.get("searchBy")&&t.get("searchTerm")?(s=t.get("searchRegExp"),i=""+function(){var t,s,i,n;for(i=this.get("searchBy"),n=[],t=0,s=i.length;s>t;t++)r=i[t],n.push(e.get(r));return n}.call(t).join(" "),i.match(s)?!0:!1):!0}}(this)),new Batman.SubSet(this.filteredIndex,{offset:this.get("offset"),limit:this.get("limit")})},s.prototype._loadRecords=function(){var t;return t=this.get("requestURL"),this._alreadyRequested(t)?this.getOrSet("total",function(e){return function(){return e._cachedTotal(t)}}(this)):this._requestFromUrl(t),void(this.get("prefetch")&&this._prefetch())},s.prototype._prefetch=function(){var t,e;return t=this.get("offset")+this.get("limit"),t>=this.get("total")?void 0:(e=this.get("requestURL").replace(/offset=\d+/,"offset="+t),this._alreadyRequested(e)?void 0:this._requestFromUrl(e,{trackState:!1}))},s.prototype._requestFromUrl=function(t,e){var r;return r=(null!=e?e:{}).trackState,null==r&&(r=!0),r&&this.set("_state",this._STATES.LOADING),Batman.Paginator._requestCache[t]=!0,new Batman.Request({url:t,autosend:!0,success:function(e){return function(r){return e._handleJSON(r,t)}}(this),loaded:function(t){return function(){return r?t.set("_state",t._STATES.READY):void 0}}(this)})},s.prototype._alreadyRequested=function(t){return!!Batman.Paginator._requestCache[t]},s.prototype._cachedTotal=function(t){return Batman.Paginator._requestCache[t]},s.prototype._handleJSON=function(t,e){var s,i,n,o,a,u,c,h,f,l,g,p;for(null!=t.total?(this.set("total",t.total),h=t.records,Batman.Paginator._requestCache[e]=t.total):h=t,o=this.get("model"),i=this.get("index"),i.prevent("itemsWereAdded"),a=o.get("primaryKey"),n=i.mapToProperty("id"),f=[],l=0,g=h.length;g>l;l++)c=h[l],p=c[a],r.call(n,p)<0&&(u=new o,u._withoutDirtyTracking(function(){return this.fromJSON(c)}),f.push(u));return(s=i.add.apply(i,f))?i.allowAndFire("itemsWereAdded",s,null):void 0},s.accessor("isLoading",function(){return this.get("_state")===this._STATES.LOADING}),s.accessor("isReady",function(){return this.get("_state")===this._STATES.READY}),s.accessor("total"),s.accessor("currentPage",function(){return this.get("offset")/this.get("limit")+1}),s.accessor("totalPages",function(){return Math.ceil(this.get("total")/this.get("limit"))||0}),s.accessor("firstPage",function(){return 1===this.get("currentPage")}),s.accessor("lastPage",function(){return this.get("currentPage")===this.get("totalPages")}),s.prototype.next=function(){return this.get("lastPage")?void 0:(this.set("offset",this.get("offset")+this.get("limit")),this.resultSubSet.set("offset",this.get("offset")))},s.prototype.prev=function(){return this.get("firstPage")?void 0:(this.set("offset",this.get("offset")-this.get("limit")),this.resultSubSet.set("offset",this.get("offset")))},s.prototype._STATES={LOADING:"loading",READY:"ready"},s._requestCache={},s.clearRequestCache=function(){return this._requestCache={}},s}(Batman.Object),Batman.Paginator.View=function(t){function r(){return r.__super__.constructor.apply(this,arguments)}return e(r,t),r.accessor("paginator",function(){return this.get("controller.paginator")}),r.accessor("searchTerm",{get:function(){return this.get("paginator.searchTerm")},set:function(t,e){return this._lastValue=e,setTimeout(function(t){return function(){return t._lastValue===e?t.set("paginator.searchTerm",e):void 0}}(this),200)}}),["currentPage","totalPages","total","firstPage","lastPage"].forEach(function(t){return r.accessor(t,function(){return this.get("paginator").get(t)})}),r.prototype.next=function(){return this.get("paginator").next()},r.prototype.prev=function(){return this.get("paginator").prev()},r.accessor("items",function(){return this.get("paginator.results")}),r.accessor("isLoading",function(){return void 0===this.get("paginator.isLoading")?!0:this.get("paginator.isLoading")}),r.accessor("noItemsAtAll",function(){return!this.get("searchTerm")&&!this.get("isLoading")&&0===this.get("totalPages")}),r.accessor("noSearchResults",function(){return!!this.get("searchTerm")&&!this.get("isLoading")&&0===this.get("totalPages")}),r}(Batman.View),Batman.App.PaginatorView=Batman.Paginator.View}).call(this);